<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö booking.html */
        body { font-family: sans-serif; background: #f5f6fa; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="p-4">

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
        <p id="loading-text" class="mt-4 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <div id="app-container" class="hidden max-w-md mx-auto">
        
        <div id="register-section" class="hidden bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-bold text-blue-600 mb-4 text-center">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
            <form id="form-register" class="space-y-3">
                <input type="text" id="regName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full border p-2 rounded" required>
                <input type="text" id="regPos" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" class="w-full border p-2 rounded" required>
                <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </form>
        </div>

        <div id="guest-section" class="hidden text-center mt-10">
            <h2 class="text-2xl">‚è≥</h2>
            <p class="font-bold text-gray-700">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
            <p class="text-sm text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin</p>
        </div>

        <div id="main-menu" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-xl shadow flex justify-between items-center">
                <span class="font-bold" id="user-name">...</span>
                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded" id="user-role">USER</span>
            </div>
            
            <button onclick="showPage('task-form')" class="w-full bg-blue-600 text-white p-4 rounded-xl shadow font-bold text-left">
                üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
            </button>
            <button onclick="loadTasks()" class="w-full bg-teal-500 text-white p-4 rounded-xl shadow font-bold text-left">
                üìÖ ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
            </button>
        </div>

        <div id="task-form" class="hidden bg-white p-6 rounded-xl shadow-md mt-2">
            <h3 class="font-bold text-lg mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h3>
            <form id="form-task" class="space-y-3">
                <select id="tType" class="w-full border p-2 rounded bg-gray-50">
                    <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    <option value="‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°">‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</option>
                    <option value="‡∏≠‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà">‡∏≠‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</option>
                </select>
                <input type="text" id="tTopic" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" class="w-full border p-2 rounded" required>
                <textarea id="tDetail" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="w-full border p-2 rounded"></textarea>
                <div class="grid grid-cols-2 gap-2">
                    <input type="datetime-local" id="tStart" class="border p-2 rounded text-sm">
                    <input type="datetime-local" id="tEnd" class="border p-2 rounded text-sm">
                </div>
                <input type="file" id="tFile" class="text-sm">
                
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white p-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" onclick="showPage('main-menu')" class="flex-1 bg-gray-200 p-2 rounded">‡∏Å‡∏•‡∏±‡∏ö</button>
                </div>
            </form>
        </div>

        <div id="task-list" class="hidden space-y-3 mt-2">
            <button onclick="showPage('main-menu')" class="text-sm text-blue-500 underline mb-2">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            <div id="task-container"></div>
        </div>

    </div>

    <script>
        const LIFF_ID = "https://liff.line.me/2008677450-DMy5BGWi"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzRdoj5OhD4XzY7to3dPnFkIrPPOEYxCyX4vdgfycCGGPYalhPQ-qG9-eMJpO4H5Zdj/exec";
        let userProfile = null;

        // Init function ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô booking.html
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                checkRole();
            } catch (err) {
                alert("Init Error: " + err.message);
            }
        }

        // Service: Check Role
        async function checkRole() {
            toggleLoading(true, "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...");
            const res = await callAPI('check_role', { userId: userProfile.userId });
            toggleLoading(false);

            document.getElementById('app-container').classList.remove('hidden');

            if (!res.found) {
                showPage('register-section');
            } else if (res.user.role === 'guest') {
                showPage('guest-section');
            } else {
                document.getElementById('user-name').innerText = res.user.name;
                document.getElementById('user-role').innerText = res.user.role.toUpperCase();
                showPage('main-menu');
            }
        }

        // Handle Register Submit
        document.getElementById('form-register').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...");
            const payload = {
                userId: userProfile.userId,
                name: document.getElementById('regName').value,
                position: document.getElementById('regPos').value,
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° field ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
            };
            const res = await callAPI('register_user', payload);
            toggleLoading(false);
            if(res.status === 'success') showPage('guest-section');
        });

        // Handle Task Submit
        document.getElementById('form-task').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
            
            // File Handling
            let fileData = "", fileName = "", mimeType = "";
            const fileInput = document.getElementById('tFile');
            if(fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileData = await getBase64(file);
                fileName = file.name;
                mimeType = file.type;
            }

            const payload = {
                userId: userProfile.userId,
                type: document.getElementById('tType').value,
                topic: document.getElementById('tTopic').value,
                detail: document.getElementById('tDetail').value,
                timeStart: document.getElementById('tStart').value,
                timeEnd: document.getElementById('tEnd').value,
                fileData, fileName, mimeType
            };

            const res = await callAPI('save_task', payload);
            toggleLoading(false);
            
            if(res.status === 'success') {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                e.target.reset();
                showPage('main-menu');
            } else {
                alert("Error: " + res.message);
            }
        });

        // Load Tasks
        async function loadTasks() {
            showPage('task-list');
            toggleLoading(true, "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            const res = await callAPI('get_my_tasks', { userId: userProfile.userId });
            toggleLoading(false);
            
            const container = document.getElementById('task-container');
            container.innerHTML = "";
            if(res.tasks && res.tasks.length > 0) {
                res.tasks.forEach(t => {
                    let dateStr = t.start ? new Date(t.start).toLocaleDateString('th-TH') : "";
                    container.innerHTML += `
                        <div class="bg-white p-3 rounded shadow border-l-4 border-blue-500">
                            <div class="font-bold">${t.topic}</div>
                            <div class="text-xs text-gray-500">${dateStr} (${t.type})</div>
                            <div class="text-xs text-right text-yellow-600 font-bold">${t.status}</div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = "<p class='text-center text-gray-400'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
            }
        }

        // --- Utils Helper (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô booking.html) ---
        async function callAPI(action, data) {
            try {
                const payload = { action, ...data };
                const res = await fetch(GAS_URL, { 
                    method: 'POST', 
                    body: JSON.stringify(payload) 
                });
                return await res.json();
            } catch (err) {
                alert("API Error: " + err);
                return { status: 'error' };
            }
        }

        function toggleLoading(show, text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
            const el = document.getElementById('loading');
            document.getElementById('loading-text').innerText = text;
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function showPage(pageId) {
            ['register-section', 'guest-section', 'main-menu', 'task-form', 'task-list'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        const getBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // Start
        init();
    </script>
</body>
</html>
